pipeline {
    agent any

    environment {
        RANCHER_URL = 'https://localhost'
        API_TOKEN: credentials('rancher-api-token')
        PROJECT_ID = 'local'
        WORKLOAD = 'deployment:default:mentorr-backend'
        CONTAINER = 'mentorr-backend'
        IMAGE = "caetanodevops/mentorr-backend:${env.BUILD_NUMBER}"
    }

    stages {
        stage("Build"){
            steps {
                script {
                    dockerapp = docker.build("caetanodevops/mentorr-backend:${env.BUILD_NUMBER}")
                }
            }
        }

        stage("Registry"){
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub'){
                        dockerapp.push()
                    }
                }
            }
        }

        stage("Deploy"){
            steps {
                sh """
                curl -k -u "${API_TOKEN}" \\
                      -X PUT "${RANCHER_URL}/v3/project/${PROJECT_ID}/workloads/${WORKLOAD}" \\
                      -H 'Content-Type: application/json' \\
                      -d '{
                        "type": "workload",
                        "containers": [{
                            "name": "${CONTAINER}",
                            "image": "${IMAGE}"
                        }]
                      }'
                """
            }
        }
    }
}
